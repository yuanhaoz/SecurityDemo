# 摘要认证

## 为什么需要认证

经由HTTP协议进行通信的数据大都是未经加密的明文，包括请求参数、返回值、cookie、head等数据，因此，外界对通信的监听，便可轻而易举地根据请求和响应双方的格式，伪造请求与响应，修改和窃取各种信息。相对于基于TCP协议层面的通信方式，针对HTTP协议的攻击门槛更低。因此，基于HTTP协议的Web与SOA架构，在应用的安全性方面需要更加重视。

通过插件，可以清楚地看到HTTP请求所生成的任何参数及响应的body信息，这些数据如果没有特殊处理，都是未经加密的明文，包括用户的用户名与密码。当然，浏览器插件大多数情况下只能看到本机流浪的信息。

更为危险的事情是，攻击者可以通过对一些网络核心节点的控制，再加上一些特殊的手段，如端口映射，代理监听等，使其能够监听和拦截到大量用户的通信数据包，通过对数据包进行筛选和分析，可以得到通信所涵盖的用户的所有敏感信息，如电子邮件、聊天记录甚至是登录的用户名和密码。

获取网络中HTTP协议通信的细节并非十分困难的事情。为了防止在通信的过程中，数据被中途拦截和修改，或者虚假的客户端冒充正常的客户端发起请求，非法与服务端进行通信，获取数据，再或者是客户端与虚假的服务端进行通信，将个人信息泄露给恶意的攻击者，需要对请求和响应的参数及客户端的身份或服务端的身份进行认证，以保证正确信息发送给了合法的接收者。

## 摘要认证的原理

对于普通的非敏感数据，我们更多关注其真实性和准确性，因此，如果在通信过程中保障数据不被篡改，首当其冲称为需要考虑的问题。

鉴于使用HTTPS性能上的成本以及需要额外申请CA证书，在这种情况下，一般采用对参数和响应进行摘要的方法，即能够满足需求。

针对每次请求和响应，按照一定的规则生成数字摘要，数字摘要需要涵盖客户端与服务端通信的内容，以及双方约定好的“盐”，以此来保障请求与响应不被第三方篡改。常见的摘要算法包括MD5、SHA等。

由于传递端与接收端都认为HTTP协议的请求参数是无序的，因此客户端与服务端双方需要约定好参数的排序方式。请求的参数经过排序后，再将参数名称和值经过一定的策略组织起来，加上一个密钥 secret，也就是所谓的“盐”，然后通过约定的摘要算法生成数字摘要，传递给服务端。

在服务单接收到客户端传递的参数后，服务端会采用与客户端相同的策略对参数进行排序，并且加上相同的secret，采用相同的摘要方式生成摘要串。由于相同内容经过相同的摘要算法，生成的摘要内容必定是相同的。将服务端生成的摘要串与客户端生成摘要串进行比较，这样可以得知参数内容是否被篡改。

同样的，服务端返回的响应也需要加上 secret，采用约定好的摘要算法生成相应的摘要，并将生成的摘要作为响应的一部分，返回给客户端，以便验证服务端返回数据的合法性。

当客户端接收到服务端的响应后，加上相同的 secret 进行拼接，并采用与服务端相同的摘要算法进行摘要，生成的摘要串与服务端传递过来的摘要串进行比较，这样便可得知服务端的响应是否被篡改。

由于摘要算法的不可逆性，并且大部分情况下不同的请求参数会有不同的服务端响应，鉴于参数和响应的多变性，摘要认证这种方式能够在一定程度上防止信息被篡改，保障通信的安全。但是，摘要认证的安全性取决于 secret 的安全性，由于服务端与客户端采用的是相同的 secret，一旦 secret泄露，通信的安全则无法保障。

## 摘要认证的实现

摘要认证这种方式可以在一定程度上保障通信的安全，防止通信过程中数据被第三方篡改。实现起来主要包含如下四个方面：客户端参数摘要生成、服务端参数摘要校验、服务端相应摘要生成和客户端相应摘要校验。