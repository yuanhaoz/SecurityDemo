# HTTPS 协议

## HTTPS 协议原理

摘要认证和签名认证虽然能够解决数据完整性和通信两端合法性问题，但是对于一些较为敏感的信息，如个人隐私数据、用户名密码等，这些信息如以明文的形式传递，一旦用户的通信被拦截，相关信息会有较大的泄露风险，因此，有必要采用更加严密的手段来保障信息的安全。

HTTPS的全称是 Hypertext Transfer Protocol over Secure Socket Layer，即基于SSL的HTTP协议，简单地说就是HTTP的安全版。依托SSL协议，HTTPS协议能够确保整个通信过程都是经过加密的，密钥随机产生，并且能够通过数字证书验证通信双方的身份，以此来保障信息安全。其中证书中包含了证书所代表一端的公钥，以及一些所具有基本信息，如机构名称、证书所作用域名、证书的数字签名等，通过数字签名能校验证书的真实性。通信的内容使用对称加密方式进行加密，通信两端约定好通信密码后，通过公钥对密码进行加密传输，只有该公钥对应的私钥，也就是通信的另一端能够解密获得通信密码，这样既保证了通信的安全，也使加密性能和时间成本可控。

如下图所示，HTTPS协议在HTTP协议与TCP协议增加了一层安全层，所有请求和响应数据在经过网络传输之前，都会先进行加密，然后再进行传输。SSL及其继任者TLS是为网络通信提供安全与数据完整性保障的一种安全协议，利用加密技术，以维护互联网数据传输的安全，验证通信双方的身份，防止数据在网络传输的过程中被拦截和窃听。

![Image text](https://github.com/yuanhaoz/SecurityDemo/blob/develop/src/main/java/com/zyh/HTTPS协议/HTTPS1.png)

HTTPS既支持单向认证，也支持双向认证，所谓的单向认证即只校验服务端证书的有效性，而双向认证则表示既校验服务端证书的有效性，同时也需要校验客户端证书的有效性。大部分情况下我们并不需要用到客户端证书，很多用户甚至没有客户端证书，但是在某些特定的环境下，如企业内部网络和涉及大额交易支付的场景下，也需要对用户的客户端证书进行校验，以保证通信的安全。

## SSL/TLS

SSL 的全称为 Secure Sockets Layer，即安全套接层。它是一种网络安全协议，目的是为了保障网络通信的安全，校验通信双方的身份，加密传输的数据。如图所示，SSL在传输层与应用层之间进行数据通信的加密。

SSL 协议的优势在于它与应用层协议独立无关，高层的应用层协议如 HTTP、SSH、FTP等等，能透明的建立与SSL协议之上，在应用层通信之前就已经完成加密算法、通信密钥的协商以及服务端及哭护短的认证工作，在此之后所有应用层协议所传输的数据都会被加密，从而保证通信的私密性。

SSL的继任者TLS协议，全称为 Transport Layer Security，即传输层安全协议，是基于SSL协议的通用化协议，同样位于应用层与传输层之间，正逐步接替SSL成为下一代网络安全协议。

SSL/TLS 协议均可以分为两层：一层为 Record Protocol，即记录协议；另一层为 Handshake Protocol，即握手协议。记录协议建立在可靠的传输协议（如TCP）之上，提供数据封装、加密解密、数据压缩、数据校验等基本功能。握手协议建立在记录协议之上，在实际的数据传输开始前，进行加密算法的协商，通信密钥的交换，通信双方身份的认证等工作。

SSL握手协议比较复杂，它大致的工作流程如下图所示。

![Image text](https://github.com/yuanhaoz/SecurityDemo/blob/develop/src/main/java/com/zyh/HTTPS协议/HTTPS2.png)

```markdown
(1) 客户端发送一个 client hello 消息，消息包含协议的版本信息、sessionid、客户端支持的加密算法、压缩算法等信息，并且还包含客户端产生的随机数。
(2) 服务端响应一个 server hello 消息，消息包含服务端产生的随机数、协议版本信息、Sessionid、压缩算法信息，还包含有服务端数字证书。如果服务端配置的是双向认证，那么服务端请求客户端证书。
(3) 客户端通过证书链验证服务端证书的有效性。
(4) 如果证书验证通过，客户端将向服务端发送经过服务端公钥加密的预主密钥，即 PreMaster Secret（PMS）。假如服务端在上一个步骤请求了客户端证书，客户端会将客户端证书发送给服务端进行校验。
(5) 服务端验证客户端证书的有效性，并用自己的私钥对PMS进行解密，使用 client hello 与 server hello 两个步骤所生成的随机数，加上解密的 PMS 来生成主密钥，即 Master Secret（MS），然后通过 MS 生成加密密钥。
(6) 客户端也将使用 client hello 与 server hello 两个步骤所生成的随机数，加上 PMS 来生成 MS，然后通过 MS 来生成加密密钥。
(7) 通知服务端未来信息使用加密密钥加密。
(8) 给服务端发送加密密钥来加密信息，终止握手。
(9) 通知客户端使用加密密钥加密。
(10) 给客户端发送加密密钥来加密信息，终止握手。
```

完成握手后，客户端与服务端便可以开始加密数据通信了，过程如下所示。

![Image text](https://github.com/yuanhaoz/SecurityDemo/blob/develop/src/main/java/com/zyh/HTTPS协议/HTTPS3.png)

在服务端与客户端真正的数据交换阶段，实际上数据是通过对称加密算法来实现加密的，密钥为双方约定好的加密密钥。客户端首先使用加密密钥来加密请求内容，发送给服务端，服务端使用加密密钥对请求进行解密并处理相应的请求，然后生成响应内容。响应经过加密密钥加密后，发送给客户端，客户端通过加密密钥对响应内容进行解密，以获得响应内容。