# CSRF 攻击

CSRF 攻击的全称是跨站请求伪造（cross site request forgery），是一种对网站的恶意利用，尽管听起来跟XSS跨站脚本攻击有点相似，但事实上CSRF与XSS差别很大，XSS利用的是站点内的信任用户，而CSRF则是通过伪装来自受信任用户的请求来利用受信任的网站。你可以这么理解CSRF攻击：攻击者盗用了你的身份，以你的名义向第三方网站发送恶意请求。CSRF能做的事情包括利用你的身份发邮件、发短信、进行交易转账等，甚至盗取你的账号。

## 1. CSRF 攻击原理

CSRF攻击原理如下图所示。

![Image text](https://github.com/yuanhaoz/SecurityDemo/blob/develop/src/main/java/com/zyh/常见的Web攻击手段/CSRF攻击/CSRF.png)

首先用户C浏览并登录了受信任站点A，登录信息验证通过以后，站点B会在返回给浏览器的信息中带上已登录的cookie，cookie信息会在浏览器端保存一定时间（根据服务端设置而定）。完成这一步以后，用户在没有登出（清除站点A的cookie）站点A的情况下，访问恶意站点B，这时恶意站点B的某个页面向站点A发起请求，而这个请求会带上浏览器端所保存的站点A的cookie，站点A根据请求所带的cookie，判断此请求为用户C所发送的。因此，站点A会根据用户C的权限来处理恶意站点B所发送的请求，而这个请求可能以用户C的身份发送邮件、短信、消息，以及进行转账支付等操作，这样恶意站点B就达到了伪造用户C请求站点A的目。

受害者只需要做下面两件事情，攻击者就能完成CSRF攻击：

- 登录受信任站点A，并在本地生成 cookie；
- 在不登出站点A（清除站点A的cookie）的情况下，访问恶意站点B。

很多情况下所谓的恶意站点，很有可能是一个存在其他漏洞（如XSS）的受信任且被很多人访问的站点，这样，普通用户可能在不知不觉中便成了受害者。

## 2. CSRF 的防御

（1）将 cookie 设置为 HttpOnly。

CSRF攻击很大程度上是利用了浏览器的cookie，为了防止站内的XSS漏洞盗取cookie，需要在cookie中设置“HttpOnly”属性，这样通过程序就无法读取到cookie信息，避免了攻击者伪造cookie的情况出现。

（2）增加token。

CSRF 攻击之所以能够成功，是因为攻击者可以伪造用户的请求，该请求中所有的用户验证信息都存在于cookie中，因此攻击者可以在不知道用户验证信息的情况下直接利用用户的cookie来通过安全验证。由此可知，抵御CSRF攻击的关键在于：在请求中放入攻击者所不能伪造的信息，并且该信息不存在与cookie之中。鉴于此，系统开发人员可以在HTTP请求中以参数的形式加入一个随机产生的token，并且在服务端进行token校验，如果请求中没有token或者token内容不正确，则认为是CSRF攻击而拒绝该请求。

（3）通过 Referer 识别

根据HTTP协议，在HTTP头中有一个字段叫 Referer，它记录了该HTTP请求的来源地址。在通常情况下，访问一个受限的页面的请求都来自于同一个网站。比如某银行的转账是通过用户访问 http://www.xxx.com/transfer.do 页面完成的，用户必须登录 www.xxx.com，然后通过单击页面上的提交按钮来触发转账事件。当用户提交请求时，该转账请求的Referer值就会是提交按钮所在页面的URL（本例为www.xxx.com/transfer.do）。如果攻击者要对银行网站实施CSRF攻击，他只能在其他网站构造请求，当用户通过其他网站发送请求到银行时，该请求的Referer的值是其他网站的网址，而不是银行转账页面的地址。因此，要防御CSRF攻击，银行网站只需要对于每一个转账请求验证其Referer值即可，如果是以www.xxx.com域名开头的地址，则说明该请求时来自于银行网站自己的请求，是合法的；如果Referer是其他网站，就有可能是CSRF攻击，则拒绝该请求。